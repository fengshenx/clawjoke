name: ClawJoke CI + Safe Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

envUP_DIR:
  BACK: backend/backups

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run backend tests
        run: |
          cd backend
          npm ci
          npm test

      - name: Build backend
        run: npm run build:backend

      - name: Build frontend
        run: npm run build:frontend

  docker-build:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: clawjoke-backend:latest, clawjoke-frontend:latest

  # Safe deployment to VPS
  deploy-safe:
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for safe deployment

      - name: Setup SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            cd /root/clawjoke
            
            echo "üöÄ Starting safe deployment..."
            
            # Step 1: Backup database BEFORE any changes
            echo "üì¶ Backing up database..."
            mkdir -p $BACKUP_DIR
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            if [ -f backend/data/data.db ]; then
              cp backend/data/data.db $BACKUP_DIR/data.db.$TIMESTAMP
              JOKES=$(sqlite3 $BACKUP_DIR/data.db.$TIMESTAMP "SELECT COUNT(*) FROM jokes;" 2>/dev/null || echo "0")
              echo "   ‚úÖ Backup created with $JOKES jokes"
              cp $BACKUP_DIR/data.db.$TIMESTAMP /root/backup_latest.db
            else
              echo "   ‚ö†Ô∏è No existing database"
            fi
            
            # Step 2: Verify critical data exists
            if [ -f backend/data/data.db ]; then
              JOKES=$(sqlite3 backend/data/data.db "SELECT COUNT(*) FROM jokes;" 2>/dev/null || echo "0")
              echo "üîç Current jokes in DB: $JOKES"
              if [ "$JOKES" -gt 0 ]; then
                echo "‚úÖ Critical data confirmed, proceeding with deployment..."
              fi
            fi
            
            # Step 3: Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Step 4: Restore database from backup if needed
            if [ ! -f backend/data/data.db ] || [ $(sqlite3 backend/data/data.db "SELECT COUNT(*) FROM jokes;" 2>/dev/null || echo "0") -eq 0 ]; then
              if [ -f /root/backup_latest.db ]; then
                echo "üîÑ Restoring database from backup..."
                cp /root/backup_latest.db backend/data/data.db
                echo "‚úÖ Database restored!"
              else
                echo "‚ö†Ô∏è No backup found, will start fresh"
              fi
            fi
            
            # Step 5: Deploy
            echo "üöÄ Running docker compose..."
            docker compose down
            
            # Ensure data directory exists
            mkdir -p backend/data
            
            # Final safety check before starting
            if [ ! -f backend/data/data.db ]; then
              echo "üìù Creating new database..."
            fi
            
            docker compose up -d --build
            
            # Step 6: Verify
            echo "‚úÖ Verifying deployment..."
            sleep 10
            
            # Check services
            BACKEND_RUNNING=$(docker inspect -f '{{.State.Running}}' clawjoke-backend-1 2>/dev/null || echo "false")
            FRONTEND_RUNNING=$(docker inspect -f '{{.State.Running}}' clawjoke-frontend-1 2>/dev/null || echo "false")
            
            if [ "$BACKEND_RUNNING" = "true" ] && [ "$FRONTEND_RUNNING" = "true" ]; then
              echo "‚úÖ All services running!"
              
              # Final data check
              API_JOKES=$(curl -s https://clawjoke.com/api/jokes?sort=new 2>/dev/null | grep -o '"id"' | wc -l || echo "0")
              echo "üìä Jokes visible via API: $API_JOKES"
              
              if [ "$API_JOKES" -gt 0 ]; then
                echo "üéâ Deployment SUCCESSFUL with data preserved!"
              else
                echo "‚ö†Ô∏è Deployment complete but no jokes visible"
              fi
            else
              echo "‚ùå Deployment FAILED"
              docker compose logs
              exit 1
            fi
